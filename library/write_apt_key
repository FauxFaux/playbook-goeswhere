#!/usr/bin/env python3
import os

import subprocess
import tempfile


def main():
    module = AnsibleModule(
        argument_spec=dict(
            contents=dict(required=True, type='str'),
            name=dict(required=True, type='str'),
        ),
        supports_check_mode=True
    )

    contents = module.params['contents']
    name = module.params['name']

    dest = '/etc/apt/trusted.gpg.d/{}.gpg'.format(name)

    if os.path.isfile(dest):
        module.exit_json(changed=False)

    if module.check_mode:
        module.exit_json(changed=True)

    with tempfile.NamedTemporaryFile(suffix='.gpg') as tmp:
        proc = subprocess.Popen(['gpg', '--no-default-keyring', '--import', '--keyring', tmp.name],
                                universal_newlines=True,
                                stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        _, gpg_err = proc.communicate(contents)
        if 0 != proc.wait():
            raise Exception('gpg failed: {}'.format(gpg_err))

        subprocess.check_call(['gpg', '--no-default-keyring', '--export', '--keyring', tmp.name, '--output', dest])

    module.exit_json(changed=True)


# import module snippets
from ansible.module_utils.basic import *

main()
